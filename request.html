<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request Food - Bhookmukt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }

      .form-step {
        display: none;
      }

      .form-step.active {
        display: block;
      }

      .step-indicator {
        position: relative;
      }

      .step-indicator::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #e5e7eb;
        z-index: 1;
      }

      .step-indicator .step {
        position: relative;
        z-index: 2;
        background-color: white;
      }

      .step-indicator .step.active {
        background-color: #e53e3e;
        color: white;
      }

      .step-indicator .step.completed {
        background-color: #48bb78;
        color: white;
      }

      .form-input {
        @apply w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-red-600 transition duration-300;
      }

      .form-label {
        @apply block text-gray-700 text-sm font-medium mb-2;
      }

      .btn-primary {
        @apply bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition duration-300;
      }

      .btn-secondary {
        @apply bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition duration-300;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Header will be injected here -->
    <div id="header"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12">
      <div class="max-w-3xl mx-auto">
        <!-- Page Title -->
        <div class="text-center mb-12" data-aos="fade-up">
          <h1 class="text-4xl font-bold text-gray-800 mb-4">Request Food</h1>
          <p class="text-xl text-gray-600">
            Need food assistance? We're here to help connect you with food
            donors in your area.
          </p>
        </div>

        <!-- Progress Steps -->
        <div class="mb-12">
          <div class="step-indicator flex justify-between items-center px-4">
            <div
              class="step active flex items-center justify-center w-10 h-10 rounded-full border-2 border-red-600"
            >
              1
            </div>
            <div
              class="step flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300"
            >
              2
            </div>
            <div
              class="step flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300"
            >
              3
            </div>
          </div>
          <div class="flex justify-between text-sm text-gray-600 mt-4">
            <span>Requirements</span>
            <span>Location</span>
            <span>Contact</span>
          </div>
        </div>

        <!-- Multi-step Form -->
        <form id="requestForm" class="bg-white rounded-lg shadow-md p-8">
          <!-- Step 1: Requirements -->
          <div class="form-step active" data-step="1">
            <h2 class="text-2xl font-semibold mb-6">Food Requirements</h2>
            <div class="space-y-6">
              <div>
                <label class="form-label">Number of People</label>
                <input
                  type="number"
                  class="form-input"
                  name="quantity"
                  required
                  min="1"
                />
              </div>
              <div>
                <label class="form-label">Type of Food Needed</label>
                <select class="form-input" name="foodType" required>
                  <option value="">Select food type</option>
                  <option value="cooked">Cooked Food</option>
                  <option value="packaged">Packaged Food</option>
                  <option value="raw">Raw Ingredients</option>
                  <option value="any">Any Available Food</option>
                </select>
              </div>
              <div>
                <label class="form-label">Urgency Level</label>
                <select class="form-input" name="urgency" required>
                  <option value="">Select urgency</option>
                  <option value="immediate">Immediate (Within 2 hours)</option>
                  <option value="urgent">Urgent (Within 4 hours)</option>
                  <option value="normal">Normal (Within 24 hours)</option>
                </select>
              </div>
              <div>
                <label class="form-label">Special Requirements</label>
                <textarea
                  class="form-input h-32"
                  name="description"
                  placeholder="Any dietary restrictions or special needs..."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Step 2: Location -->
          <div class="form-step" data-step="2">
            <h2 class="text-2xl font-semibold mb-6">Delivery Location</h2>
            <div class="space-y-6">
              <div>
                <label class="form-label">Address</label>
                <textarea
                  class="form-input h-24"
                  name="address"
                  placeholder="Enter your complete address"
                  required
                ></textarea>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="form-label">City</label>
                  <input type="text" class="form-input" name="city" required />
                </div>
                <div>
                  <label class="form-label">State</label>
                  <input type="text" class="form-input" name="state" required />
                </div>
              </div>
              <div>
                <label class="form-label">Pincode</label>
                <input type="text" class="form-input" name="pincode" required />
              </div>
              <div>
                <label class="form-label">Landmark (Optional)</label>
                <input
                  type="text"
                  class="form-input"
                  name="landmark"
                  placeholder="Nearby landmark for easy identification"
                />
              </div>
              <div>
                <label class="form-label">Preferred Delivery Time</label>
                <select class="form-input" name="deliveryTime" required>
                  <option value="">Select time</option>
                  <option value="morning">Morning (6 AM - 12 PM)</option>
                  <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                  <option value="evening">Evening (5 PM - 9 PM)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Step 3: Contact -->
          <div class="form-step" data-step="3">
            <h2 class="text-2xl font-semibold mb-6">Contact Information</h2>
            <div class="space-y-6">
              <div>
                <label class="form-label">Full Name</label>
                <input
                  type="text"
                  class="form-input"
                  name="fullName"
                  required
                />
              </div>
              <div>
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-input" name="phone" required />
              </div>
              <div>
                <label class="form-label">Email (Optional)</label>
                <input type="email" class="form-input" name="email" />
              </div>
              <div>
                <label class="form-label">Best Time to Contact</label>
                <select class="form-input" name="contactTime" required>
                  <option value="">Select time</option>
                  <option value="morning">Morning (6 AM - 12 PM)</option>
                  <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                  <option value="evening">Evening (5 PM - 9 PM)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Form Navigation -->
          <div class="flex justify-between mt-8">
            <button
              type="button"
              class="btn-secondary"
              id="prevBtn"
              style="display: none"
            >
              Previous
            </button>
            <button type="button" class="btn-primary" id="nextBtn">Next</button>
            <button
              type="submit"
              class="btn-primary"
              id="submitBtn"
              style="display: none"
            >
              Submit Request
            </button>
          </div>
        </form>
      </div>
    </main>

    <!-- Footer will be injected here -->
    <div id="footer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>
      // Initialize AOS
      AOS.init({
        duration: 800,
        easing: "ease-in-out",
        once: true,
      });

      // Form navigation
      const form = document.getElementById("requestForm");
      const steps = document.querySelectorAll(".form-step");
      const indicators = document.querySelectorAll(".step-indicator .step");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const submitBtn = document.getElementById("submitBtn");
      let currentStep = 1;

      function showStep(step) {
        steps.forEach((s) => s.classList.remove("active"));
        document.querySelector(`[data-step="${step}"]`).classList.add("active");

        indicators.forEach((indicator, index) => {
          if (index + 1 < step) {
            indicator.classList.add("completed");
            indicator.classList.remove("active");
          } else if (index + 1 === step) {
            indicator.classList.add("active");
            indicator.classList.remove("completed");
          } else {
            indicator.classList.remove("active", "completed");
          }
        });

        prevBtn.style.display = step === 1 ? "none" : "block";
        nextBtn.style.display = step === steps.length ? "none" : "block";
        submitBtn.style.display = step === steps.length ? "block" : "none";
      }

      nextBtn.addEventListener("click", () => {
        if (currentStep < steps.length) {
          currentStep++;
          showStep(currentStep);
        }
      });

      prevBtn.addEventListener("click", () => {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        try {
          // Collect form data
          const formData = new FormData(form);
          const requestData = {
            foodType: formData.get("foodType"),
            quantity: parseInt(formData.get("quantity")),
            urgency: formData.get("urgency"),
            description: formData.get("description"),
            address: formData.get("address"),
            city: formData.get("city"),
            state: formData.get("state"),
            pincode: formData.get("pincode"),
            landmark: formData.get("landmark"),
            deliveryTime: formData.get("deliveryTime"),
            fullName: formData.get("fullName"),
            phone: formData.get("phone"),
            email: formData.get("email"),
            contactTime: formData.get("contactTime"),
            // Set requiredBy based on urgency
            requiredBy: new Date(
              Date.now() + getRequiredByOffset(formData.get("urgency"))
            ),
          };

          // Send data to API
          const response = await fetch("/api/requests", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              // For testing purposes, we'll skip authentication
              // In production, you would need to include a valid Firebase token
              // 'Authorization': `Bearer ${firebaseToken}`
            },
            body: JSON.stringify(requestData),
          });

          const result = await response.json();

          if (response.ok) {
            alert(
              "Your request has been submitted! We will contact you shortly."
            );
            form.reset();
            currentStep = 1;
            showStep(currentStep);
          } else {
            throw new Error(result.message || "Failed to submit request");
          }
        } catch (error) {
          console.error("Error submitting request:", error);
          alert(`Error: ${error.message}. Please try again.`);
        } finally {
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Request";
        }
      });

      // Helper function to calculate requiredBy date based on urgency
      function getRequiredByOffset(urgency) {
        switch (urgency) {
          case "immediate":
            return 2 * 60 * 60 * 1000; // 2 hours
          case "urgent":
            return 4 * 60 * 60 * 1000; // 4 hours
          case "normal":
            return 24 * 60 * 60 * 1000; // 24 hours
          default:
            return 24 * 60 * 60 * 1000; // Default to 24 hours
        }
      }

      // Load header and footer
      window.addEventListener("DOMContentLoaded", () => {
        fetch("header.html")
          .then((res) => res.text())
          .then((data) => (document.getElementById("header").innerHTML = data));

        fetch("footer.html")
          .then((res) => res.text())
          .then((data) => (document.getElementById("footer").innerHTML = data));
      });
    </script>
  </body>
</html>
